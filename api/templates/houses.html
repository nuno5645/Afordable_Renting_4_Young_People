<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Houses Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <!-- Add houses data -->
    <script type="application/json" id="housesData">{{ houses_json | safe }}</script>
    <style>
        .modal-backdrop {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-backdrop.show {
            opacity: 1;
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }
        .contacted {
            background-color: rgba(34, 197, 94, 0.1);
            border-left: 4px solid rgb(34, 197, 94);
        }
        
        .contact-button {
            transition: all 0.2s ease-in-out;
        }
        
        .contact-button.contacted {
            background-color: rgb(34, 197, 94);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }

        /* Enhanced animations and transitions */
        .page-transition {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        .page-transition.show {
            opacity: 1;
            transform: translateY(0);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .contact-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .contact-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .contact-button:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }

        .contact-button.contacted {
            background-color: rgb(34, 197, 94);
            transform: scale(1.02);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .search-input {
            transition: all 0.3s ease;
        }

        .search-input:focus {
            transform: scale(1.02);
        }

        .table-header {
            position: sticky;
            top: 0;
            background: #1f2937;
            z-index: 10;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease forwards;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .card-hover {
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Loading Overlay with improved blur effect -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-white text-lg">Loading houses...</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Enhanced Header -->
        <div class="mb-8 animate__animated animate__fadeIn">
            <h1 class="text-4xl font-bold text-white mb-4">
                Houses Dashboard
            </h1>
            <p class="text-gray-400">Manage and track your house listings efficiently</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 stats-grid">
            <div class="stats-card">
                <h3 class="text-gray-400 text-sm">Total Houses</h3>
                <p class="text-white text-2xl font-bold" id="totalHouses">0</p>
            </div>
            <div class="stats-card">
                <h3 class="text-gray-400 text-sm">Contacted Houses</h3>
                <p class="text-white text-2xl font-bold" id="contactedHouses">0</p>
            </div>
            <div class="stats-card">
                <h3 class="text-gray-400 text-sm">Average Price</h3>
                <p class="text-white text-2xl font-bold" id="averagePrice">€0</p>
            </div>
            <div class="stats-card">
                <h3 class="text-gray-400 text-sm">Average Area</h3>
                <p class="text-white text-2xl font-bold" id="averageArea">0 m²</p>
            </div>
        </div>

        <!-- Enhanced Table Container -->
        <div class="bg-gray-800 rounded-xl shadow-2xl overflow-hidden animate__animated animate__fadeInUp">
            <!-- Improved Search and Controls -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="relative flex-1">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="Search houses..." 
                               class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all search-input pl-10">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-gray-300 whitespace-nowrap">Items per page:</label>
                            <select id="pageSizeSelect" 
                                    class="px-3 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button id="toggleView" 
                                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all">
                            Toggle View
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Card View -->
            <div class="md:hidden">
                <!-- Mobile Sorting Controls -->
                <div class="p-4 border-b border-gray-700 bg-gray-800">
                    <div class="flex items-center gap-2">
                        <label class="text-gray-300 whitespace-nowrap">Sort by:</label>
                        <select id="mobileSortSelect" 
                                class="px-3 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all flex-1">
                            <option value="">None</option>
                            <option value="Price">Price</option>
                            <option value="Area">Area</option>
                            <option value="Bedrooms">Bedrooms</option>
                            <option value="Zone">Zone</option>
                        </select>
                        <button id="mobileSortOrder" 
                                class="px-3 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all">
                            ↑
                        </button>
                    </div>
                </div>
                <div id="mobileHousesList">
                    <!-- Houses will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-700 text-gray-200 text-left">
                            <th class="px-6 py-3 cursor-pointer hover:bg-gray-600" data-column="Name">
                                Name
                                <span class="sort-icon ml-1">↕</span>
                            </th>
                            <th class="px-6 py-3 cursor-pointer hover:bg-gray-600" data-column="Zone">
                                Zone
                                <span class="sort-icon ml-1">↕</span>
                            </th>
                            <th class="px-6 py-3 cursor-pointer hover:bg-gray-600" data-column="Price">
                                Price
                                <span class="sort-icon ml-1">↕</span>
                            </th>
                            <th class="px-6 py-3">URL</th>
                            <th class="px-6 py-3 cursor-pointer hover:bg-gray-600" data-column="Bedrooms">
                                Bedrooms
                                <span class="sort-icon ml-1">↕</span>
                            </th>
                            <th class="px-6 py-3 cursor-pointer hover:bg-gray-600" data-column="Area">
                                Area
                                <span class="sort-icon ml-1">↕</span>
                            </th>
                            <th class="px-6 py-3">Description</th>
                            <th class="px-6 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for house in houses %}
                        <tr class="hover:bg-gray-700/50 transition-colors {% if house.contacted %}contacted{% endif %}"
                            id="desktop-house-{{ house.Name|replace(' ', '-') }}">
                            <td class="px-6 py-4 text-gray-300">{{ house.Name }}</td>
                            <td class="px-6 py-4 text-gray-300">{{ house.Zone }}</td>
                            <td class="px-6 py-4 text-gray-300">{{ "{:,.0f}".format(house.Price) }}</td>
                            <td class="px-6 py-4">
                                <a href="{{ house.URL }}" target="_blank" class="text-blue-400 hover:text-blue-300">View Listing</a>
                            </td>
                            <td class="px-6 py-4 text-gray-300">{{ house.Bedrooms }}</td>
                            <td class="px-6 py-4 text-gray-300">{{ house.Area }} m²</td>
                            <td class="px-6 py-4">
                                {% if house.Description %}
                                <button onclick="showDescription(`{{ house.Description|e }}`)" 
                                        class="px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm text-white transition-colors">
                                    View Details
                                </button>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <button onclick="toggleContacted('{{ house.Name|e }}')" 
                                        class="px-3 py-1 contact-button rounded-lg text-sm text-white transition-colors
                                               {% if house.contacted %}bg-green-600 hover:bg-green-700{% else %}bg-gray-600 hover:bg-gray-700{% endif %}">
                                    {{ 'Contacted ✓' if house.contacted else 'Mark as Contacted' }}
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Enhanced Pagination -->
            <div class="px-6 py-4 bg-gray-800 border-t border-gray-700">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="text-sm text-gray-400" id="paginationInfo">
                        Loading...
                    </div>
                    <div class="flex flex-wrap gap-2" id="paginationControls">
                        <!-- Pagination buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Modal -->
    <div id="descriptionModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-gray-800 rounded-xl max-w-2xl w-full mx-4 shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">Property Details</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="text-gray-300 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <script>
        let allHouses = [];
        let currentPage = 1;
        let pageSize = 10;
        let filteredHouses = [];
        let currentSortColumn = null;
        let currentSortOrder = 'asc';
        let viewMode = 'table'; // or 'cards'
        let mobileSortOrder = 'asc';

        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Initialize pagination
        function initializePagination() {
            const totalPages = Math.ceil(filteredHouses.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, filteredHouses.length);
            
            // Update pagination info
            document.getElementById('paginationInfo').textContent = 
                `Showing ${start + 1} to ${end} of ${filteredHouses.length} houses`;
            
            // Generate pagination controls
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';
            
            // Previous button
            const prevButton = createPaginationButton('Previous', currentPage > 1, () => {
                if (currentPage > 1) changePage(currentPage - 1);
            });
            controls.appendChild(prevButton);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || 
                    i === totalPages || 
                    (i >= currentPage - 2 && i <= currentPage + 2)
                ) {
                    const pageButton = createPaginationButton(i.toString(), true, () => changePage(i));
                    if (i === currentPage) {
                        pageButton.classList.add('bg-blue-500');
                        pageButton.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    }
                    controls.appendChild(pageButton);
                } else if (
                    (i === currentPage - 3 && currentPage > 4) ||
                    (i === currentPage + 3 && currentPage < totalPages - 3)
                ) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-2 text-gray-400';
                    ellipsis.textContent = '...';
                    controls.appendChild(ellipsis);
                }
            }
            
            // Next button
            const nextButton = createPaginationButton('Next', currentPage < totalPages, () => {
                if (currentPage < totalPages) changePage(currentPage + 1);
            });
            controls.appendChild(nextButton);
        }

        // Create pagination button
        function createPaginationButton(text, enabled, onClick) {
            const button = document.createElement('button');
            button.className = `px-4 py-2 rounded-lg text-sm ${
                enabled 
                    ? 'bg-gray-700 hover:bg-gray-600 text-white cursor-pointer' 
                    : 'bg-gray-700 text-gray-400 cursor-not-allowed'
            }`;
            button.textContent = text;
            if (enabled) {
                button.addEventListener('click', onClick);
            }
            return button;
        }

        // Change page
        function changePage(newPage) {
            currentPage = newPage;
            displayHouses();
        }

        // Format price consistently
        function formatPrice(price) {
            return new Intl.NumberFormat('pt-PT', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }

        // Sort houses
        function sortHouses(column) {
            showLoading();
            
            // Toggle sort order if clicking the same column
            if (currentSortColumn === column) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortOrder = 'asc';
            }

            // Update desktop sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = '↕';
            });
            const clickedHeader = document.querySelector(`th[data-column="${column}"] .sort-icon`);
            if (clickedHeader) {
                clickedHeader.textContent = currentSortOrder === 'asc' ? '↑' : '↓';
            }

            // Update mobile sort controls
            const mobileSortSelect = document.getElementById('mobileSortSelect');
            const mobileSortOrderBtn = document.getElementById('mobileSortOrder');
            mobileSortSelect.value = column;
            mobileSortOrderBtn.textContent = currentSortOrder === 'asc' ? '↑' : '↓';

            // Sort the houses array
            filteredHouses.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];

                // Handle numeric columns
                if (column === 'Price' || column === 'Area' || column === 'Bedrooms') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                } else {
                    // String comparison for non-numeric columns
                    valueA = String(valueA || '').toLowerCase();
                    valueB = String(valueB || '').toLowerCase();
                }

                if (valueA < valueB) return currentSortOrder === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            // Reset to first page and update display
            currentPage = 1;
            displayHouses();
            hideLoading();
        }

        // Display houses
        function displayHouses() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const displayedHouses = filteredHouses.slice(start, end);

            // Update stats first
            updateStats();

            // Update mobile view
            const mobileContainer = document.getElementById('mobileHousesList');
            if (mobileContainer) {
                mobileContainer.innerHTML = displayedHouses.map(house => `
                    <div class="p-4 border-b border-gray-700 transition-all ${house.contacted ? 'contacted' : ''}"
                         id="mobile-house-${house.Name.replace(/ /g, '-')}">
                        <div class="space-y-2">
                            <div>
                                <span class="text-gray-400">Name:</span>
                                <span class="text-white ml-2">${house.Name}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Price:</span>
                                <span class="text-white ml-2">${formatPrice(house.Price)}€</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Area:</span>
                                <span class="text-white ml-2">${house.Area} m²</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Bedrooms:</span>
                                <span class="text-white ml-2">${house.Bedrooms}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Zone:</span>
                                <span class="text-white ml-2">${house.Zone}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">URL:</span>
                                <a href="${house.URL}" target="_blank" class="text-blue-400 hover:text-blue-300 ml-2">View Listing</a>
                            </div>
                            ${house.Description ? `
                            <div>
                                <button onclick="showDescription(\`${house.Description.replace(/`/g, '\\`')}\`)" 
                                        class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                    View Details
                                </button>
                            </div>
                            ` : ''}
                            <div>
                                <button onclick="toggleContacted('${house.Name.replace(/'/g, "\\'")}')" 
                                        class="w-full px-4 py-2 contact-button ${house.contacted ? 'contacted' : ''} 
                                               text-white rounded-lg transition-colors mb-2
                                               ${house.contacted ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                                    ${house.contacted ? 'Contacted ✓' : 'Mark as Contacted'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update desktop view
            const tbody = document.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = displayedHouses.map(house => `
                    <tr class="hover:bg-gray-700/50 transition-colors ${house.contacted ? 'contacted' : ''}"
                        id="desktop-house-${house.Name.replace(/ /g, '-')}">
                        <td class="px-6 py-4 text-gray-300">${house.Name}</td>
                        <td class="px-6 py-4 text-gray-300">${house.Zone}</td>
                        <td class="px-6 py-4 text-gray-300">${formatPrice(house.Price)}€</td>
                        <td class="px-6 py-4">
                            <a href="${house.URL}" target="_blank" class="text-blue-400 hover:text-blue-300">View Listing</a>
                        </td>
                        <td class="px-6 py-4 text-gray-300">${house.Bedrooms}</td>
                        <td class="px-6 py-4 text-gray-300">${house.Area} m²</td>
                        <td class="px-6 py-4">
                            ${house.Description ? `
                            <button onclick="showDescription(\`${house.Description.replace(/`/g, '\\`')}\`)" 
                                    class="px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm text-white transition-colors">
                                View Details
                            </button>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="toggleContacted('${house.Name.replace(/'/g, "\\'")}')" 
                                    class="px-3 py-1 contact-button rounded-lg text-sm text-white transition-colors
                                           ${house.contacted ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                                ${house.contacted ? 'Contacted ✓' : 'Mark as Contacted'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            initializePagination();
        }

        // Filter houses
        function filterHouses(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            filteredHouses = allHouses.filter(house => 
                Object.values(house).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                )
            );
            currentPage = 1;
            displayHouses();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();

            try {
                // Get houses data from embedded JSON
                const housesData = document.getElementById('housesData');
                if (housesData) {
                    allHouses = JSON.parse(housesData.textContent);
                    filteredHouses = [...allHouses];
                    
                    // Set up sorting click handlers
                    document.querySelectorAll('th[data-column]').forEach(th => {
                        th.addEventListener('click', () => {
                            const column = th.getAttribute('data-column');
                            sortHouses(column);
                        });
                    });
                    
                    displayHouses();
                }
            } catch (error) {
                console.error('Error loading houses:', error);
            } finally {
                hideLoading();
            }

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterHouses(e.target.value);
            });

            document.getElementById('pageSizeSelect').addEventListener('change', function(e) {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                displayHouses();
            });

            // Add mobile sort handlers
            document.getElementById('mobileSortSelect').addEventListener('change', function(e) {
                const column = e.target.value;
                if (column) {
                    sortHouses(column);
                } else {
                    // Reset to original order
                    filteredHouses = [...allHouses];
                    displayHouses();
                }
            });

            document.getElementById('mobileSortOrder').addEventListener('click', function() {
                const currentColumn = document.getElementById('mobileSortSelect').value;
                if (currentColumn) {
                    mobileSortOrder = mobileSortOrder === 'asc' ? 'desc' : 'asc';
                    this.textContent = mobileSortOrder === 'asc' ? '↑' : '↓';
                    sortHouses(currentColumn);
                }
            });
        });

        // Modal functionality
        const modal = document.getElementById('descriptionModal');
        const modalContent = document.getElementById('modalContent');
        const modalBackdrop = modal;
        const modalContentDiv = modal.querySelector('.modal-content');

        function showDescription(description) {
            modalContent.textContent = description;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.add('show');
                modalContentDiv.classList.add('show');
            }, 10);
        }

        function closeModal() {
            modalBackdrop.classList.remove('show');
            modalContentDiv.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            // For mobile cards
            const cards = document.querySelectorAll('.md\\:hidden > div');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            // For desktop table
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        async function toggleContacted(houseName) {
            try {
                const response = await fetch(`/toggle-contacted/${encodeURIComponent(houseName)}`, {
                    method: 'POST',
                    headers: {
                        'ngrok-skip-browser-warning': '1'
                    }
                });
                const data = await response.json();
                
                // Update UI
                const mobileElement = document.getElementById(`mobile-house-${houseName.replace(/ /g, '-')}`);
                const desktopElement = document.getElementById(`desktop-house-${houseName.replace(/ /g, '-')}`);
                const buttons = document.querySelectorAll(`button[onclick="toggleContacted('${houseName}')"]`);
                
                if (data.contacted) {
                    mobileElement?.classList.add('contacted');
                    desktopElement?.classList.add('contacted');
                    buttons.forEach(btn => {
                        btn.classList.add('contacted');
                        btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                        btn.textContent = 'Contacted ✓';
                    });
                } else {
                    mobileElement?.classList.remove('contacted');
                    desktopElement?.classList.remove('contacted');
                    buttons.forEach(btn => {
                        btn.classList.remove('contacted');
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                        btn.textContent = 'Mark as Contacted';
                    });
                }
            } catch (error) {
                console.error('Error toggling contacted state:', error);
            }
        }

        // Update pagination links to preserve search query
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const paginationLinks = document.querySelectorAll('a[href^="?page="]');
            
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                // Update pagination links with search term
                paginationLinks.forEach(link => {
                    const url = new URL(link.href);
                    if (searchTerm) {
                        url.searchParams.set('search', searchTerm);
                    } else {
                        url.searchParams.delete('search');
                    }
                    link.href = url.search;
                });
                
                // Perform search on visible items
                // ... existing search code ...
            });
        });

        let sortDirections = {};

        // Format price consistently
        function formatPrice(price) {
            return new Intl.NumberFormat('pt-PT', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }

        async function sortTable(columnIndex) {
            const table = document.querySelector('table');
            const headers = ['Name', 'Zone', 'Price', 'URL', 'Bedrooms', 'Area', 'Floor', 'Description'];
            const columnName = headers[columnIndex];
            
            // Skip sorting for non-sortable columns
            if (columnName === 'URL' || columnName === 'Description' || columnName === 'Floor') {
                return;
            }
            
            // Toggle sort direction
            sortDirections[columnIndex] = !sortDirections[columnIndex];
            const order = sortDirections[columnIndex] ? 'asc' : 'desc';
            
            // Reset all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '↕');
            
            // Update clicked column's sort icon
            const clickedHeader = table.querySelector(`th:nth-child(${columnIndex + 1}) .sort-icon`);
            clickedHeader.textContent = order === 'asc' ? '↑' : '↓';

            try {
                // Get current search and page parameters
                const urlParams = new URLSearchParams(window.location.search);
                const currentPage = urlParams.get('page') || '1';

                // Fetch sorted data
                const response = await fetch(`/sort/${columnName}?order=${order}`, {
                    headers: {
                        'ngrok-skip-browser-warning': '1'
                    }
                });
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error fetching sorted data:', data.error);
                    return;
                }

                // Calculate pagination
                const perPage = 10;
                const start = (currentPage - 1) * perPage;
                const end = start + perPage;
                const pageHouses = data.houses.slice(start, end);

                // Update mobile view
                const mobileContainer = document.querySelector('.md\\:hidden');
                if (mobileContainer) {
                    mobileContainer.innerHTML = pageHouses.map(house => `
                        <div class="p-4 border-b border-gray-700 transition-all ${house.contacted ? 'contacted' : ''}"
                             id="mobile-house-${house.Name.replace(/ /g, '-')}">
                            <div class="space-y-2">
                                <div>
                                    <span class="text-gray-400">Name:</span>
                                    <span class="text-white ml-2">${house.Name}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Price:</span>
                                    <span class="text-white ml-2">${formatPrice(house.Price)}€</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Area:</span>
                                    <span class="text-white ml-2">${house.Area} m²</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Bedrooms:</span>
                                    <span class="text-white ml-2">${house.Bedrooms}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Zone:</span>
                                    <span class="text-white ml-2">${house.Zone}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">URL:</span>
                                    <a href="${house.URL}" target="_blank" class="text-blue-400 hover:text-blue-300 ml-2">View Listing</a>
                                </div>
                                ${house.Description ? `
                                <div>
                                    <button onclick="showDescription(\`${house.Description.replace(/`/g, '\\`')}\`)" 
                                            class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                        View Details
                                    </button>
                                </div>
                                ` : ''}
                                <div>
                                    <button onclick="toggleContacted('${house.Name.replace(/'/g, "\\'")}')" 
                                            class="w-full px-4 py-2 contact-button ${house.contacted ? 'contacted' : ''} 
                                                   text-white rounded-lg transition-colors mb-2
                                                   ${house.contacted ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                                        ${house.contacted ? 'Contacted ✓' : 'Mark as Contacted'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Update desktop view
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = pageHouses.map(house => `
                        <tr class="hover:bg-gray-700/50 transition-colors ${house.contacted ? 'contacted' : ''}"
                            id="desktop-house-${house.Name.replace(/ /g, '-')}">
                            <td class="px-6 py-4 text-gray-300">${house.Name}</td>
                            <td class="px-6 py-4 text-gray-300">${house.Zone}</td>
                            <td class="px-6 py-4 text-gray-300">${formatPrice(house.Price)}€</td>
                            <td class="px-6 py-4">
                                <a href="${house.URL}" target="_blank" class="text-blue-400 hover:text-blue-300">View Listing</a>
                            </td>
                            <td class="px-6 py-4 text-gray-300">${house.Bedrooms}</td>
                            <td class="px-6 py-4 text-gray-300">${house.Area} m²</td>
                            <td class="px-6 py-4">
                                ${house.Description ? `
                                <button onclick="showDescription(\`${house.Description.replace(/`/g, '\\`')}\`)" 
                                        class="px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm text-white transition-colors">
                                    View Details
                                </button>
                                ` : ''}
                            </td>
                            <td class="px-6 py-4">
                                <button onclick="toggleContacted('${house.Name.replace(/'/g, "\\'")}')" 
                                        class="px-3 py-1 contact-button rounded-lg text-sm text-white transition-colors
                                               ${house.contacted ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                                    ${house.contacted ? 'Contacted ✓' : 'Mark as Contacted'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                // Update URL without page reload
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('sort_column', columnName);
                newUrl.searchParams.set('sort_order', order);
                window.history.pushState({}, '', newUrl.toString());

            } catch (error) {
                console.error('Error sorting table:', error);
            }
        }

        // Initialize sort directions and icons based on current URL parameters
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sortColumn = urlParams.get('sort_column');
            const sortOrder = urlParams.get('sort_order');

            if (sortColumn) {
                const headers = ['Name', 'Zone', 'Price', 'URL', 'Bedrooms', 'Area', 'Floor', 'Description'];
                const columnIndex = headers.indexOf(sortColumn);
                if (columnIndex !== -1) {
                    sortDirections[columnIndex] = sortOrder === 'asc';
                    const icon = document.querySelector(`th:nth-child(${columnIndex + 1}) .sort-icon`);
                    if (icon) {
                        icon.textContent = sortOrder === 'asc' ? '↑' : '↓';
                    }
                }
            }
        });

        // Update stats
        function updateStats() {
            const totalHouses = filteredHouses.length;
            const contacted = filteredHouses.filter(h => h.contacted).length;
            
            // Fix average price calculation by only considering valid prices
            const validPrices = filteredHouses.filter(h => h.Price && !isNaN(h.Price));
            const avgPrice = validPrices.length > 0 
                ? validPrices.reduce((acc, h) => acc + h.Price, 0) / validPrices.length 
                : 0;
            
            // Fix average area calculation by only considering valid areas
            const validAreas = filteredHouses.filter(h => h.Area && !isNaN(parseFloat(h.Area)));
            const avgArea = validAreas.length > 0
                ? validAreas.reduce((acc, h) => acc + parseFloat(h.Area), 0) / validAreas.length
                : 0;

            // Update stats without animations
            document.getElementById('totalHouses').textContent = totalHouses;
            document.getElementById('contactedHouses').textContent = contacted;
            document.getElementById('averagePrice').textContent = `€${formatPrice(avgPrice)}`;
            document.getElementById('averageArea').textContent = `${avgArea.toFixed(1)} m²`;
        }

        // Toggle view
        document.getElementById('toggleView').addEventListener('click', function() {
            const mobileView = document.querySelector('.md\\:hidden');
            const desktopView = document.querySelector('.hidden.md\\:block');
            
            if (viewMode === 'table') {
                mobileView.classList.remove('md:hidden');
                desktopView.classList.add('hidden');
                viewMode = 'cards';
                this.textContent = 'Table View';
            } else {
                mobileView.classList.add('md:hidden');
                desktopView.classList.remove('hidden');
                viewMode = 'table';
                this.textContent = 'Card View';
            }
        });
    </script>
</body>
</html>
